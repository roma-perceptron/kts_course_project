# ФИНАЛЬНЫЙ ЭТАП ЗАДАЧИ и ДЕЙСТВИЯ

Значит как обстоят дела: приложение запускается, создаются все необходимые объекты и сущности, стартуют все необходимые таски.
Бот ожидает сообщений, каждое полученное перекладывается в очередь на обработку менеджеом.
Менеджер обрабатывает в соответствии со своей логикой и машиной состояний. Передает ответ в очередь на отправку.
Отправщик достает сообщений из очереди и отправляет.
Все данные в процессе игры записываются в БД;

Чего нет: апишки с методами доступными для использования. Кое-какая статистика реализована, но именно апи чтобы из постмана - нету()


## Общие
- [x] Дописать мягкое завершение всех процессов: бд, поллеры и т.д.
- [ ] TODO

## Telegram Bot
- [x] Нужно набросать общую логику работы бота в качестве бота-ЧГК
- [x] В общем виде собрал заготовку машины состояний для игры
- [x] Сделал команды-состояния для вступления в команду
- [x] Проработал логику интерфейса по формированию команды — до момента старта игры
- [x] Надо реализовать в минимуме логику одной целой игры. Сделал:
    - [x] Cлучайный выбор капитана
    - [x] Таймер на обдумывание вопроса
    - [x] Таймер на ответ
    - [x] Проверку ответа
    - [x] Выставление chatAction
    - [x] Круговорот раундов
    - [x] Зачистка данных для возможности новой игры
    - [x] Есть какие-то косяки в работе.. ПОФИКСИЛ
    - [x] Досрочный ответ
    - [x] Команда для отмены игры
    - [x] ПОГОНЯТЬ ИГРЫ, ЛОВИТЬ БАГИ
    - [ ] TODO
- [x] Подключить взятие вопросов из БД
- [x] Подключить ChatGPT-генерацию
- [x] Сохранение в БД результатов
- [ ] TODO

## CHAT-GPT
- [x] Проверить базовую реализуемость идеи, получить аккаунт на openAI
- [x] Собрать прототип библы для получения вопросов
- [x] Подобрать структуру промтов для формирования хороших вопросов
- [x] Переписал метод генерирующий вопрос, получается нормально
- [x] Настроил сохранение генераций в БД
- [x] Сгененрировал некоторое кол-во вопросов в базу
- [x] Нужно сделать метод для проверки ответа введенного юзером – пусть сам chatGPT и проверяет!
- [ ] TODO

## База данных
- [x] Добавить модели/таблицы для хранения вопросов
- [x] Модифицировать БД под ЧКГ полностью
  - [x] Переписать dataclass-ы
  - [x] Переписать модели
- [ ] TODO

## Аксессоры/Manager
- [x] Написать методы извлечения пачки вопросов из БД в формате датакласса
- [x] Написал пару методов для пометки использованных вопросов
- [x] Написал метод для извлечения вопросов которые еще не засвечены в данном чате+игроками
- [x] Новые методы для записи/обновлении в БД данных по:
  - [x] Игроку
  - [x] Команде
  - [x] Игре
  - [x] Результату игры
  - [x] Методы для извлечения данных из этих таблиц
- [ ] TODO
  

## AIOHTTP-приложение
- [.] Разобраться почему не работает без async в setup_app.. или пофиг уже
- [x] Сделал сохранение состояний (self.current*) в базе данных, в спец. табличке.
- [x] Апишка нужна..
  - [x] Сделал базу для апи
  - [x] Добавил пару методов
- [x] Валидация / Schemes
- [x] Swagger
- [x] Middleware
- [x] Авторизация админа для методов апи
- [.] Правильный конфиг через yaml..
- [ ] TODO

## Тесты
- [ ] TODO


---



# ПРЕДВАРИТЕЛЬНЫЙ ЭТАП - ЗАДАЧИ и ДЕЙСТВИЯ

## ИЗ ЗАДАНИЯ:
- [x] Ознакомиться с памяткой
- [x] Сделать fork проекта из памятки 
- [x] Cделать ветку dev
- [x] Cделать ветку init
- [x] В ветке init нужно реализовать следующие моменты:
    - [x] Реализовать polling server + создать бота в ВК / Телеграмм
    - [x] Реализовать echo бота, который должен дублировать отправленные сообщения
    - [x] Прикрутить alembic к проекту
    - [x] Реализовать модель игры, пользователя, счета пользователя
    - [x] Реализовать модели аксессора для:
        - [x] получения пользователей в чате (получение всех уникальных пользователей принимавших участие в играх)
        - [x] создание игры со всеми связанными сущностями (пользователь, игра, счет пользователя)
        - [x] получение последней игры вместе со всеми связанными сущностями по char_id
    

## Общие
- [x] Установить доп. библиотеки (алчеми, алембик..)
- [x] Отредактировать readme добавив инфу о себе
- [x] Применить black для форматирования..
- [x] Залить все на гитхаб
- [ ] TODO


## База данных
- [x] Создать локальную БД
- [x] Добавил в */kts_project_template/venv/bin/activate* свои переменные (путь к БД)
- [x] Настроить универсальное подключение к БД
- [x] Создать базовые модели
- [x] Сделать init миграцию
- [x] Написать базовый аксессор для записи в БД и получения данных из нее
- [x] Собрал БД так что все вроде работает
- [x] Добавил методы для тестового залива данных и тестового просмотра - работает
- [x] Сделал метод получения последней игры в заданном chat_id
- [ ] TODO

  
## Telegram Bot
- [x] Создать Бота
- [x] Добавить его token в переменные окружения
- [x] Примерно накидать архитектуру будущего функционала
- [x] Написал базовые классы Бота. Реализован getUpdates и sendMessage
- [x] Усложнил Poller - при получении сообщения он кладет его в очередь updates_queue
- [x] Усложнил Sender - он следит за очередью answers_queue и отправляет сообщения из нее
- [x] Эхо-бот готов
- [x] Добавил наивную обработку команд (/help)
- [x] Накидал код для создания объекта-игры
- [x] Переделал команды
- [ ] TODO

## Аксессоры/Manager
- [x] Нужно написать аксессор Бота, который бы запускался в приложении и уже сам реализовывал свою логику
- [x] Сделал менеджер который следит за очередью updates_queue, превращает ее элементы в ответы и кладет в answers_queue
- [x] Сделал аксессор для БД, он может записывать данные в базу и читать из нее
- [ ] TODO


## AIOHTTP-приложение
- [x] Базовое, внутри которого запускаются три корутины обменивающиеся данными через две очереди
- [ ] TODO
